<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤í„°ë”” ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        .input-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input, button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        input {
            flex: 1;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            min-width: 100px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chat-window {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .chat-window h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .message-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .message-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .message-input input {
            flex: 1;
        }
        .file-input {
            margin-top: 10px;
        }
        .file-input input {
            width: 100%;
            margin-bottom: 10px;
        }
        .message {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .message.enter {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .message.leave {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .message.file {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .message.system {
            border-left-color: #6c757d;
            background-color: #f8f9fa;
            font-style: italic;
        }
        .timestamp {
            color: #6c757d;
            font-size: 0.8em;
        }
        .sender {
            font-weight: bold;
            color: #007bff;
        }
        .file-info {
            color: #28a745;
            font-style: italic;
        }
        .connection-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ìŠ¤í„°ë”” ì±„íŒ… ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</h1>
        <p><strong>WebSocket Endpoint:</strong> /api/ws-stomp | <strong>STOMP Protocol</strong></p>
        
        <div id="status" class="status disconnected">
            ì—°ê²° ìƒíƒœ: ì—°ê²° ì•ˆë¨ âŒ
        </div>
        
        <div class="input-group">
            <label><strong>ìŠ¤í„°ë”” ID:</strong></label>
            <input type="number" id="studyId" value="1" min="1">
            <label><strong>ë©¤ë²„ ID:</strong></label>
            <input type="number" id="memberId" value="1" min="1">
        </div>
        
        <div class="input-group">
            <button onclick="connect()" id="connectBtn">ğŸ”Œ STOMP ì—°ê²°</button>
            <button onclick="disconnect()" id="disconnectBtn" disabled>âŒ ì—°ê²° í•´ì œ</button>
            <button onclick="enterRoom()" id="enterBtn" disabled>ğŸšª ì…ì¥</button>
            <button onclick="leaveRoom()" id="leaveBtn" disabled>ğŸšª í‡´ì¥</button>
        </div>
        
                 <div class="chat-container">
             <!-- ë™ì  ì±„íŒ…ë°© -->
             <div class="chat-window">
                 <h3>ğŸ’¬ ìŠ¤í„°ë””ë°© (ID: <span id="currentStudyIdDisplay">-</span>)</h3>
                 <div id="messageLog" class="message-log"></div>
                 <div class="message-input">
                     <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeypress="handleKeyPress(event)">
                     <button onclick="sendMessage()">ğŸ“¤ ì „ì†¡</button>
                 </div>
                 <div class="file-input">
                     <input type="text" id="fileUrl" placeholder="https://s3.amazonaws.com/file.pdf">
                     <button onclick="sendFileMessage()">ğŸ“ íŒŒì¼ ì „ì†¡</button>
                 </div>
             </div>
         </div>
        
        <h3>ğŸ“‹ ì—°ê²° ë¡œê·¸</h3>
        <div id="connectionLog" class="connection-log"></div>
        
        <div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px;">
            <h4>ğŸ’¡ ì‚¬ìš©ë²•</h4>
            <ol>
                <li><strong>ì—°ê²°</strong>: ğŸ”Œ STOMP ì—°ê²° ë²„íŠ¼ í´ë¦­</li>
                <li><strong>ì…ì¥</strong>: ğŸšª ì…ì¥ ë²„íŠ¼ í´ë¦­ (ìë™ìœ¼ë¡œ ë¨)</li>
                <li><strong>ì±„íŒ…</strong>: ë‘ ê°œì˜ ì±„íŒ…ë°©ì—ì„œ ê°ê° ë©”ì‹œì§€ ì „ì†¡</li>
                <li><strong>ì‹¤ì‹œê°„ í™•ì¸</strong>: ë‹¤ë¥¸ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ê°™ì€ URL ì ‘ì†í•˜ì—¬ ì‹¤ì‹œê°„ í†µì‹  í™•ì¸</li>
                                 <li><strong>STOMP í”„ë¡œí† ì½œ</strong>: /app/chat.sendMessage/{studyId}ë¡œ ë©”ì‹œì§€ ì „ì†¡, /topic/chat/room/{studyId}ë¡œ êµ¬ë…</li>
                 <li><strong>Context-Path</strong>: /api (WebSocket: /api/ws-stomp)</li>
                 <li><strong>ë°ì´í„°ë² ì´ìŠ¤</strong>: ë‹¨ì¼ ê¸°ë³¸í‚¤ + íŒŒí‹°ì…”ë‹ ì§€ì›</li>
            </ol>
        </div>
    </div>

    <script>
        let stompClient = null;
        let isConnected = false;
        let currentStudyId = 1;
        let currentMemberId = 1;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('connectionLog');
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(connected) {
            isConnected = connected;
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const enterBtn = document.getElementById('enterBtn');
            const leaveBtn = document.getElementById('leaveBtn');
            
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'ì—°ê²° ìƒíƒœ: STOMP ì—°ê²°ë¨ âœ…';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                enterBtn.disabled = false;
                leaveBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'ì—°ê²° ìƒíƒœ: ì—°ê²° ì•ˆë¨ âŒ';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                enterBtn.disabled = true;
                leaveBtn.disabled = true;
            }
        }
        
                 function connect() {
             currentStudyId = parseInt(document.getElementById('studyId').value);
             currentMemberId = parseInt(document.getElementById('memberId').value);
             
             // í™”ë©´ì— í˜„ì¬ ìŠ¤í„°ë”” ID í‘œì‹œ
             document.getElementById('currentStudyIdDisplay').textContent = currentStudyId;
             
             log(`STOMP WebSocket ì—°ê²° ì‹œë„: ws://ec2-3-113-246-191.ap-northeast-1.compute.amazonaws.com:8080/api/ws-stomp`);
             log(`ì—°ê²° ì‹œë„ ì‹œê°„: ${new Date().toLocaleString()}`);
             log(`ìŠ¤í„°ë”” ID: ${currentStudyId}, ë©¤ë²„ ID: ${currentMemberId}`);
             
             try {
                 const socket = new SockJS('/api/ws-stomp');
                 stompClient = Stomp.over(socket);
                 
                 const connectHeaders = {
                     'accept-version': '1.1,1.0'
                 };
                 
                 log(`ğŸ“¡ STOMP ì—°ê²° ì‹œë„...`);
                 
                 stompClient.connect(connectHeaders, function(frame) {
                     log(`âœ… STOMP WebSocket ì—°ê²° ì„±ê³µ!`, 'success');
                     log(`Frame: ${frame}`, 'info');
                     updateStatus(true);
                     
                     // ìë™ìœ¼ë¡œ ì…ì¥
                     enterRoom();
                     
                 }, function(error) {
                     log(`âŒ STOMP WebSocket ì—°ê²° ì‹¤íŒ¨: ${error}`, 'error');
                     updateStatus(false);
                 });
                 
             } catch (error) {
                 log(`âŒ WebSocket ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                 updateStatus(false);
             }
         }
        
        function disconnect() {
            if (stompClient) {
                stompClient.disconnect();
                log('ğŸ”Œ STOMP WebSocket ì—°ê²° í•´ì œë¨', 'info');
                updateStatus(false);
            }
        }
        
                 function enterRoom() {
             if (!stompClient || !isConnected) {
                 log('âŒ STOMP WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                 return;
             }
             
             // í˜„ì¬ ì…ë ¥ëœ ìŠ¤í„°ë”” IDë¡œ êµ¬ë…
             const topic = `/topic/chat/room/${currentStudyId}`;
             log(`ğŸ“¡ STOMP êµ¬ë… ì‹œì‘: ${topic}`);
             
             stompClient.subscribe(topic, function(message) {
                 const messageData = JSON.parse(message.body);
                 log(`ğŸ“¨ ìŠ¤í„°ë”” ${currentStudyId} ë©”ì‹œì§€ ìˆ˜ì‹ : ${JSON.stringify(messageData, null, 2)}`, 'message');
                 addMessageToChat(messageData);
             });
             
             log(`âœ… ìŠ¤í„°ë””ë°© ${currentStudyId} STOMP êµ¬ë… ì™„ë£Œ`);
             
             // ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
             sendEnterMessage();
         }
        
                 function leaveRoom() {
             if (!stompClient || !isConnected) {
                 log('âŒ STOMP WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                 return;
             }
             
             // í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡
             sendLeaveMessage();
         }
        
                 function sendMessage() {
             if (!stompClient || !isConnected) {
                 log('âŒ STOMP WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                 return;
             }
             
             const content = document.getElementById('messageInput').value;
             
             if (!content.trim()) {
                 log('âŒ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                 return;
             }
             
             const message = {
                 memberId: currentMemberId,
                 studyProjectId: currentStudyId,
                 content: content,
                 fileUrl: null,
                 messageType: 'TEXT'
             };
             
             log(`ğŸ“¤ STOMP ë©”ì‹œì§€ ì „ì†¡: /app/chat.sendMessage/${currentStudyId}`);
             log(`ë©”ì‹œì§€ ë‚´ìš©: ${JSON.stringify(message)}`);
             
             stompClient.send(`/app/chat.sendMessage/${currentStudyId}`, {}, JSON.stringify(message));
             
             document.getElementById('messageInput').value = '';
         }
        
                 function sendFileMessage() {
             if (!stompClient || !isConnected) {
                 log('âŒ STOMP WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                 return;
             }
             
             const content = document.getElementById('messageInput').value || 'íŒŒì¼ ê³µìœ ';
             const fileUrl = document.getElementById('fileUrl').value;
             
             if (!fileUrl.trim()) {
                 log('âŒ íŒŒì¼ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                 return;
             }
             
             const message = {
                 memberId: currentMemberId,
                 studyProjectId: currentStudyId,
                 content: content,
                 fileUrl: fileUrl,
                 messageType: 'FILE'
             };
             
             log(`ğŸ“ STOMP íŒŒì¼ ë©”ì‹œì§€ ì „ì†¡: /app/chat.sendFileMessage/${currentStudyId}`);
             log(`ë©”ì‹œì§€ ë‚´ìš©: ${JSON.stringify(message)}`);
             
             stompClient.send(`/app/chat.sendMessage/${currentStudyId}`, {}, JSON.stringify(message));
             
             document.getElementById('messageInput').value = '';
             document.getElementById('fileUrl').value = '';
         }
        
                 function sendEnterMessage() {
             if (!stompClient || !isConnected) return;
             
             const message = {
                 memberId: currentMemberId,
                 studyProjectId: currentStudyId,
                 content: 'ë‹˜ì´ ìŠ¤í„°ë””ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.',
                 fileUrl: null,
                 messageType: 'ENTER'
             };
             
             stompClient.send(`/app/chat.enter/${currentStudyId}`, {}, JSON.stringify(message));
         }
        
                 function sendLeaveMessage() {
             if (!stompClient || !isConnected) return;
             
             const message = {
                 memberId: currentMemberId,
                 studyProjectId: currentStudyId,
                 content: 'ë‹˜ì´ ìŠ¤í„°ë””ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.',
                 fileUrl: null,
                 messageType: 'LEAVE'
             };
             
             stompClient.send(`/app/chat.leave/${currentStudyId}`, {}, JSON.stringify(message));
         }
        
                 function addMessageToChat(messageData) {
             const messageLog = document.getElementById('messageLog');
             const timestamp = new Date(messageData.createdAt).toLocaleTimeString();
             
             let messageClass = 'message';
             let fileInfo = '';
             
             // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
             switch(messageData.messageType) {
                 case 'ENTER':
                     messageClass = 'message enter';
                     break;
                 case 'LEAVE':
                     messageClass = 'message leave';
                     break;
                 case 'FILE':
                     messageClass = 'message file';
                     fileInfo = `<div class="file-info">ğŸ“ íŒŒì¼: ${messageData.fileUrl}</div>`;
                     break;
                 case 'SYSTEM':
                     messageClass = 'message system';
                     break;
                 default:
                     messageClass = 'message';
             }
             
             messageLog.innerHTML += `
                 <div class="${messageClass}">
                     <div class="timestamp">[${timestamp}]</div>
                     <div class="sender">${messageData.senderNick}</div>
                     <div>${messageData.content}</div>
                     ${fileInfo}
                 </div>
             `;
             messageLog.scrollTop = messageLog.scrollHeight;
         }
        
                 function handleKeyPress(event) {
             if (event.key === 'Enter') {
                 sendMessage();
             }
         }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            log('ğŸ§ª ìŠ¤í„°ë”” ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
            log('WebSocket Endpoint: /api/ws-stomp');
            log('STOMP Protocol: /app (ì „ì†¡), /topic (êµ¬ë…)');
            log('ì‚¬ìš©ë²•: 1. STOMP ì—°ê²° â†’ 2. ì…ì¥ â†’ 3. ë©”ì‹œì§€ ì „ì†¡');
            log('ğŸ’¡ ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸: ë‹¤ë¥¸ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ê°™ì€ URL ì ‘ì†');
        };
    </script>
</body>
</html>


